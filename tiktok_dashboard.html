<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Viewbot - Custom Booster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #0f172a 100%);
            min-height: 100vh;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, sans-serif;
        }
        .navbar {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 3px solid #00f7ef;
        }
        .navbar-brand {
            background: linear-gradient(135deg, #00f7ef 0%, #0084ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            font-size: 1.8rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1rem;
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #00f7ef;
            color: #ffffff;
            box-shadow: 0 0 15px rgba(0, 247, 239, 0.3);
        }
        .form-label {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .btn-boost {
            background: linear-gradient(135deg, #00f7ef 0%, #0084ff 100%);
            border: none;
            color: white;
            font-weight: 700;
            padding: 14px 32px;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .btn-boost:hover {
            background: linear-gradient(135deg, #0084ff 0%, #00f7ef 100%);
            transform: translateY(-2px);
            color: white;
        }
        .btn-boost:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .captcha-container {
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed rgba(0, 247, 239, 0.5);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .captcha-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 247, 239, 0.2);
        }
        .status-msg {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 1rem;
        }
        .status-loading {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.5);
            color: #93c5fd;
        }
        .status-success {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid rgba(34, 197, 94, 0.5);
            color: #86efac;
        }
        .status-error {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid rgba(220, 38, 38, 0.5);
            color: #fca5a5;
        }
        h3 {
            color: #ffffff;
            font-weight: 700;
            font-size: 1.6rem;
        }
        .text-muted {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        small {
            color: rgba(255, 255, 255, 0.7);
            display: block;
            margin-top: 8px;
        }
        .input-group-text {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/tiktok"><i class="bi bi-music-note-beamed"></i> TikTok Viewbot</a>
            <a class="btn btn-outline-light btn-sm" href="/"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
    </nav>

    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <!-- Phase 1: Initial Setup -->
                <div id="phase1" class="card p-5">
                    <h3 class="mb-4"><i class="bi bi-rocket"></i> TikTok Booster - Choose Service</h3>
                    
                    <div class="alert" style="background: rgba(0, 247, 239, 0.2); border: 2px solid #00f7ef; border-radius: 10px;">
                        <small style="color: #ffffff;"><i class="bi bi-info-circle"></i> <strong>Pick a provider & service</strong> - Instant boosts, no hassle</small>
                    </div>

                    <input type="hidden" id="boostProvider" value="zefame">

                    <div class="mb-4">
                        <label class="form-label">üöÄ Select Boost Type</label>
                        <select class="form-control" id="boostService" onchange="updateServiceInfo()">
                            <option value="">-- Loading Services --</option>
                        </select>
                        <small id="serviceInfo" style="color: rgba(255,255,255,0.7); margin-top: 10px; display: block;">Fetching available services...</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">TikTok Video/Profile URL</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" class="form-control" id="tiktokUrl" placeholder="https://www.tiktok.com/@username/video/..." value="" onchange="checkVideoStats()">
                            <button class="btn btn-outline-light btn-sm" type="button" onclick="checkVideoStats()" style="white-space: nowrap;">üìä Check Stats</button>
                        </div>
                        <small>Paste your full TikTok video or profile link</small>
                    </div>

                    <!-- Video/Profile Stats Display -->
                    <div id="videoStats" style="display:none; background: rgba(76, 175, 80, 0.15); border: 2px solid rgba(76, 175, 80, 0.5); border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <p class="text-muted mb-2">üìà <strong style="color: #4caf50;" id="statsTitle">Current Video Stats</strong></p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
                            <div>
                                <p class="text-muted mb-1" style="font-size: 0.85rem;" id="viewLabel">Views</p>
                                <h4 style="color: #4caf50; margin: 0;" id="viewCount">0</h4>
                            </div>
                            <div>
                                <p class="text-muted mb-1" style="font-size: 0.85rem;" id="likeLabel">Likes</p>
                                <h4 style="color: #ff6b9d; margin: 0;" id="likeCount">0</h4>
                            </div>
                            <div>
                                <p class="text-muted mb-1" style="font-size: 0.85rem;" id="shareLabel">Followers</p>
                                <h4 style="color: #00f7ef; margin: 0;" id="shareCount">0</h4>
                            </div>
                        </div>
                    </div>


                    <div class="alert" style="background: rgba(76, 175, 80, 0.15); border: 2px solid rgba(76, 175, 80, 0.5); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                        <small style="color: #86efac;"><i class="bi bi-info-circle"></i> <strong>Boost Details:</strong> 100 views delivered every 5 minutes until stopped</small>
                    </div>

                    <button class="btn btn-boost w-100 btn-lg" onclick="startBoost()" id="loadBtn">
                        <i class="bi bi-play-circle"></i> Start Boost
                    </button>

                    <div id="statusMsg" style="display:none;"></div>
                </div>

                <!-- Phase 2: Captcha Solving -->
                <div id="phase2" style="display:none;" class="card p-5 mt-4">
                    <h4 class="mb-3"><i class="bi bi-shield-check"></i> Verify Security</h4>
                    
                    <div class="captcha-container">
                        <p class="text-muted mb-3">Verification Challenge:</p>
                        <img id="captchaImage" class="captcha-image" src="" alt="Captcha">
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Enter Captcha Answer</label>
                        <input type="text" class="form-control" id="captchaInput" placeholder="e.g., 10" value="">
                        <small>Enter the answer to the math problem shown above</small>
                    </div>

                    <button class="btn btn-boost w-100 btn-lg" onclick="submitCaptchaAndStart()" id="submitBtn">
                        <i class="bi bi-check-circle"></i> Submit Captcha & Start Boost Loop
                    </button>

                    <button class="btn btn-outline-light w-100 mt-3" onclick="startSession()">
                        <i class="bi bi-arrow-clockwise"></i> Reload Captcha
                    </button>

                    <div id="captchaStatus" style="display:none;"></div>
                </div>

                <!-- Phase 3: Boosting -->
                <div id="phase3" style="display:none;" class="card p-5 mt-4">
                    <h4 class="mb-3"><i class="bi bi-activity"></i> Boost Loop Running</h4>
                    
                    <div id="boostStatus" class="status-msg status-loading">
                        üîÑ Starting boost loop...
                    </div>

                    <!-- Real-time Order Feed -->
                    <div style="background: rgba(76, 175, 80, 0.15); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 10px; padding: 15px; margin: 15px 0; max-height: 300px; overflow-y: auto;">
                        <p class="text-muted mb-2" style="font-size: 0.9rem;">üì§ <strong style="color: #4caf50;">Order Feed</strong></p>
                        <div id="orderFeed" style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                            <p style="color: rgba(255,255,255,0.6); margin: 0;">Waiting for orders...</p>
                        </div>
                    </div>

                    <!-- Timer Display -->
                    <div id="timerDisplay" style="display:none; background: rgba(255, 193, 7, 0.15); border: 2px solid rgba(255, 193, 7, 0.5); border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center;">
                        <p class="text-muted mb-2">‚è±Ô∏è Time Until Next Cycle:</p>
                        <h3 style="color: #fbc02d; font-size: 2rem; margin: 0;" id="timerValue">--</h3>
                    </div>


                    <button class="btn btn-danger w-100" onclick="stopSession()" id="stopBtn">
                        <i class="bi bi-stop-circle"></i> Stop Boost Loop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let statusPolling = null;
        let selectedService = null;
        let zefameServices = [];

        async function loadServices() {
            try {
                const provider = document.getElementById('boostProvider').value;
                const response = await fetch(`/tiktok/api/get-services?provider=${provider}`);
                const services = await response.json();
                zefameServices = services;
                
                const select = document.getElementById('boostService');
                select.innerHTML = '<option value="">-- Choose Boost Type --</option>';
                
                services.forEach(svc => {
                    if (svc.available) {
                        const option = document.createElement('option');
                        option.value = svc.id;
                        option.textContent = svc.display;
                        select.appendChild(option);
                    }
                });
                
                document.getElementById('serviceInfo').textContent = 'Select a boost type to get started';
            } catch (e) {
                console.error('Error loading services:', e);
                document.getElementById('serviceInfo').textContent = '‚ùå Failed to load services';
            }
        }

        function updateServiceInfo() {
            const serviceId = document.getElementById('boostService').value;
            const service = zefameServices.find(s => s.id == serviceId);
            const infoEl = document.getElementById('serviceInfo');
            if (service) {
                infoEl.textContent = `‚úÖ ${service.display}`;
                selectedService = serviceId;
            } else {
                infoEl.textContent = 'Select a boost type';
            }
        }

        // Load services when page loads
        document.addEventListener('DOMContentLoaded', loadServices);

        async function checkVideoStats() {
            const url = document.getElementById('tiktokUrl').value.trim();
            if (!url) {
                document.getElementById('videoStats').style.display = 'none';
                return;
            }

            const btn = event?.target;
            if (btn) btn.disabled = true;

            try {
                const response = await fetch('/tiktok/api/get-video-info', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url})
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    const isProfile = data.type === 'profile';
                    
                    // Update UI labels and content
                    document.getElementById('statsTitle').textContent = isProfile ? 'üë§ Profile Stats' : 'üìà Video Stats';
                    
                    if (isProfile) {
                        document.getElementById('viewLabel').textContent = 'Followers';
                        document.getElementById('likeLabel').textContent = 'Bio';
                        document.getElementById('shareLabel').textContent = 'Status';
                        
                        document.getElementById('viewCount').textContent = formatNumber(data.followers);
                        document.getElementById('likeCount').textContent = '@' + data.username;
                        document.getElementById('shareCount').textContent = '‚úÖ Ready to boost';
                        
                        // Auto-select followers service if it's a profile
                        const followerOption = Array.from(document.getElementById('boostService').options).find(opt => opt.textContent.includes('Followers'));
                        if (followerOption) {
                            document.getElementById('boostService').value = followerOption.value;
                            updateServiceInfo();
                        }
                    } else {
                        document.getElementById('viewLabel').textContent = 'Views';
                        document.getElementById('likeLabel').textContent = 'Likes';
                        document.getElementById('shareLabel').textContent = 'Followers';
                        
                        document.getElementById('viewCount').textContent = formatNumber(data.views);
                        document.getElementById('likeCount').textContent = formatNumber(data.likes);
                        document.getElementById('shareCount').textContent = formatNumber(data.followers);
                    }
                    
                    document.getElementById('videoStats').style.display = 'block';
                } else if (data.error || data.status === 'error') {
                    document.getElementById('videoStats').style.display = 'none';
                    showStatus('‚ùå ' + (data.error || data.message || 'Failed to fetch stats'), 'error', 'phase1');
                }
            } catch (e) {
                console.error('Error fetching video info:', e);
                showStatus('‚ùå Error: ' + e.message, 'error', 'phase1');
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function formatNumber(num) {
            if (typeof num !== 'number' || num === 0 || !num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }


        async function startBoost() {
            const provider = 'zefame';
            const service_id = parseInt(document.getElementById('boostService').value);
            const url = document.getElementById('tiktokUrl').value.trim();
            const service = zefameServices.find(s => s.id === service_id);

            if (!service_id || !service) {
                showStatus('‚ùå Select a boost type first', 'error', 'phase1');
                return;
            }
            if (!url) {
                showStatus('‚ùå Enter your TikTok URL', 'error', 'phase1');
                return;
            }

            document.getElementById('loadBtn').disabled = true;
            showStatus('üîÑ Starting ' + service.name + '...', 'loading', 'phase1');

            try {
                const response = await fetch('/tiktok/api/start-boost', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, service_id, url, min_views: 100, max_views: 100})
                });
                
                const data = await response.json();
                if (data.session_id) {
                    currentSessionId = data.session_id;
                    document.getElementById('phase1').style.display = 'none';
                    document.getElementById('phase3').style.display = 'block';
                    pollBoostStatus();
                } else {
                    showStatus('‚ùå ' + (data.error || 'Failed to start'), 'error', 'phase1');
                    document.getElementById('loadBtn').disabled = false;
                }
            } catch (e) {
                showStatus('‚ùå Error: ' + e.message, 'error', 'phase1');
                document.getElementById('loadBtn').disabled = false;
            }
        }

        async function startSession() {
            const url = document.getElementById('tiktokUrl').value.trim();
            const type = document.getElementById('boostType').value;

            if (!url) {
                showStatus('‚ùå Enter your TikTok URL', 'error', 'phase1');
                return;
            }

            document.getElementById('loadBtn').disabled = true;
            showStatus('üîÑ Initializing...', 'loading', 'phase1');

            try {
                const response = await fetch('/tiktok/api/start-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();
                currentSessionId = data.session_id;

                // Poll for captcha
                pollForCaptcha();
            } catch (e) {
                showStatus('‚ùå Error: ' + e.message, 'error', 'phase1');
                document.getElementById('loadBtn').disabled = false;
            }
        }

        function pollForCaptcha() {
            statusPolling = setInterval(async () => {
                try {
                    const response = await fetch(`/tiktok/api/session-status/${currentSessionId}`);
                    const status = await response.json();

                    if (status.status === 'captcha_ready') {
                        clearInterval(statusPolling);
                        document.getElementById('phase1').style.display = 'none';
                        document.getElementById('phase2').style.display = 'block';
                        document.getElementById('captchaImage').src = 'data:image/png;base64,' + status.captcha_image;
                    } else if (status.status === 'error') {
                        clearInterval(statusPolling);
                        showStatus('‚ùå ' + status.message, 'error', 'phase1');
                        document.getElementById('loadBtn').disabled = false;
                    } else {
                        showStatus('üîÑ ' + status.message, 'loading', 'phase1');
                    }
                } catch (e) {
                    clearInterval(statusPolling);
                }
            }, 1000);
        }

        async function submitCaptchaAndStart() {
            const url = document.getElementById('tiktokUrl').value.trim();
            const type = document.getElementById('boostType').value;
            const captcha = document.getElementById('captchaInput').value.trim();

            if (!captcha) {
                showStatus('‚ùå Enter the captcha', 'error', 'phase2');
                return;
            }

            document.getElementById('submitBtn').disabled = true;
            showStatus('‚å®Ô∏è Submitting captcha...', 'loading', 'phase2');

            try {
                const response = await fetch('/tiktok/api/submit-captcha', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        captcha: captcha,
                        url: url,
                        type: type
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showStatus('‚ùå ' + (error.error || 'Failed'), 'error', 'phase2');
                    document.getElementById('submitBtn').disabled = false;
                    return;
                }

                // Switch to boost phase
                document.getElementById('phase2').style.display = 'none';
                document.getElementById('phase3').style.display = 'block';

                // Poll boost status
                pollBoostStatus();
            } catch (e) {
                showStatus('‚ùå Error: ' + e.message, 'error', 'phase2');
                document.getElementById('submitBtn').disabled = false;
            }
        }

        let screenRefresh = null;
        let lastTotalSent = 0;
        
        function pollBoostStatus() {
            statusPolling = setInterval(async () => {
                try {
                    const response = await fetch(`/tiktok/api/session-status/${currentSessionId}`);
                    const status = await response.json();

                    const boostDiv = document.getElementById('boostStatus');
                    boostDiv.textContent = status.message || 'üîÑ Boost running... check feed below for orders';
                    boostDiv.className = 'status-msg status-loading';

                    // Parse total sent from message and add to feed if new
                    const totalMatch = status.message?.match(/Total sent: (\d+)/);
                    if (totalMatch) {
                        const currentTotal = parseInt(totalMatch[1]);
                        if (currentTotal > lastTotalSent) {
                            // New orders were sent - add to feed
                            const timestamp = new Date().toLocaleTimeString();
                            const orderDiv = document.createElement('div');
                            orderDiv.style.padding = '8px';
                            orderDiv.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                            const diff = currentTotal - lastTotalSent;
                            orderDiv.innerHTML = `<span style="color: #4caf50;">‚úÖ ${timestamp}</span> - +${diff} sent!`;
                            const orderFeed = document.getElementById('orderFeed');
                            if (orderFeed.children.length > 0 && orderFeed.children[0].textContent.includes('Waiting')) {
                                orderFeed.innerHTML = '';
                            }
                            orderFeed.insertBefore(orderDiv, orderFeed.firstChild);
                            
                            // Keep only last 20 orders
                            while (orderFeed.children.length > 20) {
                                orderFeed.removeChild(orderFeed.lastChild);
                            }
                            lastTotalSent = currentTotal;
                        }
                    }

                    if (status.status === 'stopped' || status.status === 'success') {
                        clearInterval(statusPolling);
                        clearInterval(screenRefresh);
                        boostDiv.textContent = status.message || '‚úÖ Boost stopped';
                        boostDiv.className = 'status-msg status-success';
                        document.getElementById('stopBtn').disabled = true;
                    }
                } catch (e) {
                    clearInterval(statusPolling);
                }
            }, 1000);

            // Start live screen capture every 250ms for real-time viewing
            screenRefresh = setInterval(async () => {
                try {
                    const response = await fetch(`/tiktok/api/session-screenshot/${currentSessionId}`);
                    const data = await response.json();
                    if (data.screenshot) {
                        document.getElementById('botScreen').src = 'data:image/png;base64,' + data.screenshot;
                    }
                } catch (e) {
                    // Silent fail
                }
            }, 250);
        }

        async function stopSession() {
            try {
                const response = await fetch(`/tiktok/api/stop-boost/${currentSessionId}`, {
                    method: 'POST'
                });
                clearInterval(statusPolling);
                document.getElementById('stopBtn').disabled = true;
            } catch (e) {
                console.error('Error stopping boost:', e);
            }
        }

        let cloudflareRefreshInterval = null;
        
        function setupCloudflareClickHandler() {
            const canvas = document.getElementById('clickCanvasCloudflare');
            const img = document.getElementById('botScreenCloudflare');
            
            if (!canvas || !img) return;
            
            // Match canvas size to image
            const updateCanvasSize = () => {
                const rect = img.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            };
            
            img.onload = updateCanvasSize;
            updateCanvasSize();
            
            // Handle clicks - scale coordinates from displayed image to actual 1920x1080
            canvas.onclick = async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const imgRect = document.getElementById('botScreenCloudflare').getBoundingClientRect();
                const clickX = e.clientX - imgRect.left;
                const clickY = e.clientY - imgRect.top;
                
                // Scale from displayed size to actual 1920x1080
                const scaleX = 1920 / imgRect.width;
                const scaleY = 1080 / imgRect.height;
                
                const actualX = Math.round(clickX * scaleX);
                const actualY = Math.round(clickY * scaleY);
                
                console.log(`‚úÖ CLICK RECEIVED at display (${Math.round(clickX)}, ${Math.round(clickY)}) => actual (${actualX}, ${actualY})`);
                
                // Send scaled coordinates to backend
                try {
                    const response = await fetch('/tiktok/api/click-cloudflare', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({session_id: currentSessionId, x: actualX, y: actualY})
                    });
                    console.log('Click POST response:', response.status);
                } catch (err) {
                    console.error('Failed to send click:', err);
                }
                
                canvas.style.display = 'none';
                document.getElementById('cloudflareSection').innerHTML = '‚úÖ Click received at (' + actualX + ', ' + actualY + ')! Processing...';
                
                if (cloudflareRefreshInterval) clearInterval(cloudflareRefreshInterval);
            };
        }
        
        function startCloudflareRefresh() {
            // Use existing botScreen refresh that already runs every 500ms
            const cloudflareImg = document.getElementById('botScreenCloudflare');
            
            cloudflareRefreshInterval = setInterval(() => {
                const cacheBust = Date.now();
                fetch(`/tiktok/api/session-status/${currentSessionId}?t=${cacheBust}`)
                    .then(res => res.json())
                    .then(status => {
                        if (status.screen_data) {
                            cloudflareImg.src = `data:image/png;base64,${status.screen_data}`;
                        }
                    })
                    .catch(e => console.error('Refresh failed:', e));
            }, 500);
        }

        async function stopSession() {
            if (!currentSessionId) return;

            document.getElementById('stopBtn').disabled = true;

            try {
                await fetch(`/tiktok/api/stop-session/${currentSessionId}`, {
                    method: 'POST'
                });

                clearInterval(statusPolling);
                document.getElementById('phase3').style.display = 'none';
                document.getElementById('phase1').style.display = 'block';
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('tiktokUrl').value = '';
                currentSessionId = null;
            } catch (e) {
                alert('Error: ' + e.message);
                document.getElementById('stopBtn').disabled = false;
            }
        }

        function showStatus(message, type, phase) {
            const div = document.getElementById('statusMsg');
            div.className = 'status-msg status-' + type;
            div.textContent = message;
            div.style.display = 'block';
        }
    </script>
</body>
</html>
